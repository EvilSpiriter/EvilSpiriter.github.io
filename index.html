<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能热榜解析系统</title>
    <style>
        :root {
            --primary: #1a6dff;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(90deg, var(--primary), #0d5bdd);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .header-icon {
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 24px;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            min-height: 600px;
        }
        
        /* 左侧输入面板 */
        .input-panel {
            padding: 30px;
            background: #f8f9ff;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .panel-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .input-area {
            flex: 1;
            margin-bottom: 20px;
        }
        
        textarea {
            width: 100%;
            height: 100%;
            min-height: 400px;
            padding: 20px;
            border: 2px dashed #ccc;
            border-radius: 10px;
            font-size: 14px;
            line-height: 1.6;
            resize: none;
            font-family: 'Courier New', monospace;
            transition: all 0.3s;
        }
        
        textarea:focus {
            outline: none;
            border-color: var(--primary);
            border-style: solid;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: #333; }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(26, 109, 255, 0.2);
        }
        
        /* 右侧输出面板 */
        .output-panel {
            padding: 30px;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .preview-area {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 20px;
            background: white;
        }
        
        /* 热帖预览样式 */
        .post-preview {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 8px;
            background: #f8f9ff;
            border-left: 4px solid var(--primary);
            transition: all 0.3s;
            position: relative;
        }
        
        .post-preview:hover {
            background: #e7f3ff;
            transform: translateX(5px);
        }
        
        .post-rank {
            display: inline-block;
            width: 28px;
            height: 28px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 28px;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .post-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            cursor: pointer;
            display: inline-block;
        }
        
        .post-title:hover {
            color: var(--primary);
        }
        
        .post-link {
            font-size: 12px;
            color: #666;
            margin-left: 5px;
            text-decoration: none;
        }
        
        .post-link:hover {
            color: var(--primary);
            text-decoration: underline;
        }
        
        .post-meta {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }
        
        /* 管理员面板 */
        .admin-panel {
            background: #fff8e1;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .admin-title {
            font-weight: 600;
            color: #856404;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }
        
        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        /* 消息提示 */
        .message {
            padding: 10px 15px;
            border-radius: 6px;
            margin: 10px 0;
            display: none;
        }
        
        .message-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        /* 响应式 */
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .input-panel {
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
            }
        }
        
        /* 解析状态 */
        .parse-status {
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 14px;
            display: none;
        }
        
        .parse-success {
            background: #e7f3ff;
            color: var(--primary);
            border: 1px solid #b3d7ff;
        }
        
        .parse-error {
            background: #fde8e8;
            color: var(--danger);
            border: 1px solid #f8b4b4;
        }
        
        /* 登录保护 */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        
        .login-title {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        
        /* 公共热榜页面 */
        .public-view {
            padding: 30px;
        }
        
        .public-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .public-header h2 {
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .public-header .update-time {
            color: #666;
            font-size: 14px;
        }
        
        /* 热榜项样式 */
        .hotlist-item {
            display: flex;
            align-items: center;
            padding: 20px;
            margin-bottom: 15px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }
        
        .hotlist-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .item-rank {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 20px;
            margin-right: 20px;
            flex-shrink: 0;
        }
        
        .rank-1 { background: linear-gradient(135deg, #ffd700, #ffa500); color: white; }
        .rank-2 { background: linear-gradient(135deg, #c0c0c0, #a0a0a0); color: white; }
        .rank-3 { background: linear-gradient(135deg, #cd7f32, #a66929); color: white; }
        .rank-other { background: #f0f2f5; color: #606266; }
        
        .item-content {
            flex: 1;
        }
        
        .item-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            line-height: 1.4;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .item-link {
            font-size: 12px;
            color: #666;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 3px;
        }
        
        .item-link:hover {
            color: var(--primary);
            text-decoration: underline;
        }
        
        .item-meta {
            display: flex;
            gap: 20px;
            color: #666;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .item-stats {
            display: flex;
            gap: 15px;
            font-size: 13px;
            color: #888;
        }
        
        .stat {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* 模式切换 */
        .mode-switcher {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
        }
        
        .mode-btn {
            background: white;
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
        }
        
        /* 帖子详情页样式 */
        .post-detail-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .post-detail {
            background: white;
            border-radius: 15px;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
        }
        
        .detail-header {
            padding: 30px 30px 20px;
            border-bottom: 1px solid #eee;
            position: relative;
        }
        
        .detail-close {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #f0f2f5;
            border: none;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
        }
        
        .detail-close:hover {
            background: #e4e6eb;
        }
        
        .detail-body {
            padding: 30px;
        }
        
        .detail-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 15px;
            color: #333;
        }
        
        .detail-meta {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .detail-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .stat-item {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            background: #f8f9ff;
            min-width: 100px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
        }
        
        .detail-link {
            display: inline-block;
            padding: 10px 20px;
            background: var(--primary);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            margin-top: 20px;
            transition: all 0.3s;
        }
        
        .detail-link:hover {
            background: #0d5bdd;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(26, 109, 255, 0.3);
        }
        
        .link-unavailable {
            display: none;
        }
        
        /* 链接图标 */
        .link-icon {
            font-size: 12px;
            opacity: 0.6;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- 管理员登录层 -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-box">
            <h2 class="login-title"><i class="fas fa-lock"></i> 管理员登录</h2>
            <div class="form-group">
                <label class="form-label">账号</label>
                <input type="text" class="form-control" id="adminAccount" placeholder="请输入管理员账号">
            </div>
            <div class="form-group">
                <label class="form-label">密码</label>
                <input type="password" class="form-control" id="adminPassword" placeholder="请输入密码">
            </div>
            <button class="btn btn-primary" style="width:100%;" onclick="checkLogin()">
                <i class="fas fa-sign-in-alt"></i> 登录
            </button>
            <p style="text-align:center; margin-top:15px; color:#666; font-size:12px;">
                普通用户无需登录，直接查看热榜
            </p>
        </div>
    </div>

    <!-- 管理员编辑界面 -->
    <div class="container" id="adminContainer" style="display:none;">
        <div class="header">
            <h1>
                <span class="header-icon"><i class="fas fa-robot"></i></span>
                AI热榜数据解析系统
            </h1>
            <p>将AI回复粘贴到左侧，自动解析生成热榜</p>
            <div style="margin-top:15px;">
                <button class="btn btn-warning" onclick="showPublicView()">
                    <i class="fas fa-eye"></i> 查看公共热榜
                </button>
                <button class="btn" onclick="logout()" style="background:#666; color:white; margin-left:10px;">
                    <i class="fas fa-sign-out-alt"></i> 退出
                </button>
            </div>
        </div>
        
        <div class="main-content">
            <!-- 左侧：数据输入 -->
            <div class="input-panel">
                <div class="panel-title">
                    <i class="fas fa-paste"></i> 粘贴AI回复
                </div>
                
                <div class="input-area">
                    <textarea id="aiInput" placeholder="请将AI回复的内容粘贴到这里...

支持格式示例（推荐包含链接）：
1. 今日技术分享：JavaScript新特性 [程序员小明] 2560浏览 320点赞 45评论 2小时前 链接：https://example.com/post/1
2. 前端框架对比讨论 [技术达人] 1890浏览 210点赞 32评论 3小时前 链接：https://example.com/post/2

或JSON格式（包含link字段）：
{
  'posts': [
    {
      'title': '帖子标题',
      'author': '作者名',
      'views': 1000,
      'likes': 100,
      'comments': 50,
      'time': '2小时前',
      'link': 'https://example.com/post/1'
    }
  ]
}

系统会自动提取链接，无效链接将不显示！"></textarea>
                </div>
                
                <div class="parse-status" id="parseStatus"></div>
                
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="parseAIResponse()">
                        <i class="fas fa-magic"></i> 智能解析
                    </button>
                    <button class="btn btn-warning" onclick="testWithSampleData()">
                        <i class="fas fa-vial"></i> 测试解析
                    </button>
                    <button class="btn" onclick="clearInput()" style="background:#6c757d; color:white;">
                        <i class="fas fa-trash"></i> 清空
                    </button>
                    <button class="btn btn-success" onclick="saveToPublic()" id="saveBtn" disabled>
                        <i class="fas fa-cloud-upload-alt"></i> 发布到热榜
                    </button>
                </div>
                
                <!-- 管理员配置 -->
                <div class="admin-panel">
                    <div class="admin-title">
                        <i class="fas fa-user-shield"></i> 管理员设置
                    </div>
                    <div class="form-group">
                        <label class="form-label">热榜标题</label>
                        <input type="text" class="form-control" id="hotlistTitle" value="今日频道热帖排行榜" placeholder="请输入热榜标题">
                    </div>
                    <div class="form-group">
                        <label class="form-label">更新说明</label>
                        <input type="text" class="form-control" id="updateNote" value="数据来源于频道AI分析" placeholder="更新说明">
                    </div>
                    <div class="form-group">
                        <label class="form-label">显示数量</label>
                        <select class="form-control" id="displayCount">
                            <option value="5">前5名</option>
                            <option value="10" selected>前10名</option>
                            <option value="15">前15名</option>
                            <option value="20">前20名</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <!-- 右侧：数据预览 -->
            <div class="output-panel">
                <div class="panel-title">
                    <i class="fas fa-eye"></i> 解析预览
                    <span id="parsedCount" style="font-size:12px; color:#666; margin-left:10px;">0条数据</span>
                </div>
                
                <div class="preview-area" id="previewArea">
                    <div style="text-align:center; padding:50px 20px; color:#999;">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                        <p style="margin-top:15px;">等待解析数据...</p>
                    </div>
                </div>
                
                <div class="message" id="saveMessage"></div>
            </div>
        </div>
    </div>
    
    <!-- 公共热榜页面 -->
    <div class="container" id="publicContainer" style="display:none;">
        <div class="public-view">
            <div class="public-header">
                <h2 id="publicTitle">今日频道热帖排行榜</h2>
                <div class="update-time" id="updateTime">最后更新：从未更新</div>
            </div>
            
            <div id="publicHotlist">
                <!-- 热榜内容动态生成 -->
            </div>
            
            <div style="text-align:center; margin-top:40px; padding-top:20px; border-top:1px solid #eee;">
                <button class="btn btn-primary" onclick="showAdminView()">
                    <i class="fas fa-edit"></i> 管理员登录
                </button>
                <p style="color:#666; margin-top:15px; font-size:13px;">
                    数据每24小时自动更新 • 热度根据浏览、点赞、评论综合计算
                </p>
            </div>
        </div>
    </div>

    <!-- 帖子详情页 -->
    <div class="post-detail-overlay" id="postDetailOverlay">
        <div class="post-detail">
            <div class="detail-header">
                <button class="detail-close" onclick="closePostDetail()">
                    <i class="fas fa-times"></i>
                </button>
                <h3 id="detailPostTitle">帖子标题</h3>
            </div>
            <div class="detail-body">
                <div class="detail-meta" id="detailPostMeta">
                    <!-- 元数据动态生成 -->
                </div>
                <div class="detail-stats" id="detailPostStats">
                    <!-- 统计数据动态生成 -->
                </div>
                <a href="#" target="_blank" class="detail-link" id="detailPostLink">
                    <i class="fas fa-external-link-alt"></i> 查看原帖
                </a>
            </div>
        </div>
    </div>

    <!-- 模式切换按钮 -->
    <div class="mode-switcher">
        <button class="mode-btn" id="modeSwitchBtn" onclick="switchMode()">
            <i class="fas fa-exchange-alt"></i> 切换模式
        </button>
    </div>

    <script>
        // ============================================
        // 【系统配置】
        // ============================================
        
        // 管理员账号（您可自定义）
        const ADMIN_ACCOUNT = "admin";
        const ADMIN_PASSWORD = "123456"; // 建议修改
        
        // 存储键名
        const STORAGE_KEYS = {
            HOTLIST_DATA: 'ai_hotlist_data',
            PUBLIC_DATA: 'ai_public_data',
            LOGIN_TOKEN: 'ai_login_token'
        };
        
        // 当前模式：admin（编辑） 或 public（查看）
        let currentMode = 'public';
        
        // 解析后的数据缓存
        let parsedPosts = [];
        
        // ============================================
        // 【登录验证】
        // ============================================
        
        function checkLogin() {
            const account = document.getElementById('adminAccount').value;
            const password = document.getElementById('adminPassword').value;
            
            if (account === ADMIN_ACCOUNT && password === ADMIN_PASSWORD) {
                // 生成登录令牌（有效期24小时）
                const token = {
                    account: account,
                    loginTime: new Date().toISOString(),
                    expires: Date.now() + 24 * 60 * 60 * 1000
                };
                
                localStorage.setItem(STORAGE_KEYS.LOGIN_TOKEN, JSON.stringify(token));
                
                hideLoginOverlay();
                showAdminView();
                showMessage('登录成功！', 'success');
            } else {
                showMessage('账号或密码错误', 'error');
            }
        }
        
        function checkAutoLogin() {
            const tokenStr = localStorage.getItem(STORAGE_KEYS.LOGIN_TOKEN);
            
            if (tokenStr) {
                try {
                    const token = JSON.parse(tokenStr);
                    
                    // 检查令牌是否过期
                    if (token.expires > Date.now()) {
                        // 自动登录成功
                        hideLoginOverlay();
                        showAdminView();
                        return true;
                    } else {
                        // 令牌过期，清除
                        localStorage.removeItem(STORAGE_KEYS.LOGIN_TOKEN);
                    }
                } catch (e) {
                    // 令牌无效
                    localStorage.removeItem(STORAGE_KEYS.LOGIN_TOKEN);
                }
            }
            
            // 没有登录或登录失效，显示登录界面
            showLoginOverlay();
            return false;
        }
        
        function hideLoginOverlay() {
            document.getElementById('loginOverlay').style.display = 'none';
        }
        
        function showLoginOverlay() {
            document.getElementById('loginOverlay').style.display = 'flex';
        }
        
        function logout() {
            localStorage.removeItem(STORAGE_KEYS.LOGIN_TOKEN);
            showLoginOverlay();
            showPublicView();
            showMessage('已退出登录', 'success');
        }
        
        // ============================================
        // 【AI回复解析引擎 - 增强版支持链接】
        // ============================================
        
        function parseAIResponse() {
            const input = document.getElementById('aiInput').value.trim();
            
            if (!input) {
                showParseStatus('请输入AI回复内容', 'error');
                return;
            }
            
            // 清空之前的数据
            parsedPosts = [];
            
            // 尝试不同的解析策略
            let success = false;
            
            // 策略1：解析JSON格式
            if (!success) success = tryParseJSON(input);
            
            // 策略2：解析列表格式（带数字序号和链接）
            if (!success) success = tryParseNumberedList(input);
            
            // 策略3：解析表格格式（用|或Tab分隔）
            if (!success) success = tryParseTableFormat(input);
            
            // 策略4：解析自然语言格式
            if (!success) success = tryParseNaturalLanguage(input);
            
            // 策略5：通用解析（最后手段）
            if (!success) success = tryParseGeneric(input);
            
            if (success) {
                showParseStatus(`成功解析 ${parsedPosts.length} 条热帖数据`, 'success');
                renderPreview();
                enableSaveButton();
            } else {
                showParseStatus('无法解析数据，请检查格式或尝试其他提问方式', 'error');
            }
        }
        
        function tryParseJSON(input) {
            try {
                // 清理输入，处理可能的转义字符
                let cleanedInput = input.trim();
                
                // 尝试找到JSON部分（可能AI回复包含说明文字）
                const jsonMatch = cleanedInput.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    cleanedInput = jsonMatch[0];
                }
                
                // 修复单引号为双引号（JSON标准）
                cleanedInput = cleanedInput.replace(/'/g, '"');
                
                const data = JSON.parse(cleanedInput);
                
                if (data.posts && Array.isArray(data.posts)) {
                    parsedPosts = data.posts.map((post, index) => ({
                        rank: index + 1,
                        title: post.title || post.Title || `帖子 ${index + 1}`,
                        author: post.author || post.Author || post.creator || '未知作者',
                        views: parseInt(post.views || post.Views || post.view_count || 0),
                        likes: parseInt(post.likes || post.Likes || post.like_count || 0),
                        comments: parseInt(post.comments || post.Comments || post.comment_count || 0),
                        time: post.time || post.Time || post.created_at || '最近',
                        link: extractAndValidateLink(post.link || post.Link || post.url || post.URL || '')
                    }));
                    return true;
                }
            } catch (e) {
                console.log('JSON解析失败:', e.message);
            }
            return false;
        }
        
        function tryParseNumberedList(input) {
            const lines = input.split('\n').filter(line => line.trim());
            const posts = [];
            
            lines.forEach(line => {
                line = line.trim();
                
                // 匹配格式：1. 标题 [作者] 1234浏览 567点赞 89评论 时间 链接：https://...
                const pattern1 = /^(\d+)[\.、]\s*(.+?)\s+\[(.+?)\]\s+(\d+)\s*浏览\s+(\d+)\s*点赞\s+(\d+)\s*评论\s+(.+?)(?:\s+链接[:：]\s*(https?:\/\/\S+))?$/;
                
                // 匹配格式：1. 标题 - 作者 - 1234浏览 - 567点赞 - 89评论 - 时间 - 链接：https://...
                const pattern2 = /^(\d+)[\.、]\s*(.+?)\s+[-–]\s+(.+?)\s+[-–]\s+(\d+)\s*浏览\s+[-–]\s+(\d+)\s*点赞\s+[-–]\s+(\d+)\s*评论\s+[-–]\s+(.+?)(?:\s+[-–]\s+链接[:：]\s*(https?:\/\/\S+))?$/;
                
                // 匹配格式：排名 标题（作者）1234浏览 567点赞 时间 链接：...
                const pattern3 = /^(\d+)\s+(.+?)\s*\((.+?)\)\s+(\d+)\s*浏览\s+(\d+)\s*点赞\s+(\d+)\s*评论\s+(.+?)(?:\s+链接[:：]\s*(https?:\/\/\S+))?$/;
                
                // 匹配通用格式：1. 标题 - 其他信息包含链接
                const pattern4 = /^(\d+)[\.、]\s*(.+?)(?:\s+链接[:：]\s*(https?:\/\/\S+))?$/;
                
                let match = line.match(pattern1) || line.match(pattern2) || line.match(pattern3) || line.match(pattern4);
                
                if (match) {
                    const post = {
                        rank: parseInt(match[1]),
                        title: match[2].trim(),
                        author: '未知作者',
                        views: 0,
                        likes: 0,
                        comments: 0,
                        time: '最近',
                        link: ''
                    };
                    
                    // 尝试提取作者
                    const authorMatch = line.match(/\[(.+?)\]/) || line.match(/\((.+?)\)/);
                    if (authorMatch) post.author = authorMatch[1].trim();
                    
                    // 提取数字数据
                    const viewMatch = line.match(/(\d+)\s*浏览/);
                    const likeMatch = line.match(/(\d+)\s*点赞/);
                    const commentMatch = line.match(/(\d+)\s*评论/);
                    const timeMatch = line.match(/(\d+\s*(?:分钟|小时|天)前|今天|最近)/);
                    
                    if (viewMatch) post.views = parseInt(viewMatch[1]);
                    if (likeMatch) post.likes = parseInt(likeMatch[1]);
                    if (commentMatch) post.comments = parseInt(commentMatch[1]);
                    if (timeMatch) post.time = timeMatch[0];
                    
                    // 提取链接
                    let link = '';
                    if (match[8]) link = match[8];
                    else if (match[7]) link = match[7];
                    else if (match[3]) link = match[3];
                    
                    // 如果没有通过正则提取到链接，尝试从行中提取URL
                    if (!link) {
                        const urlMatch = line.match(/https?:\/\/\S+/);
                        if (urlMatch) link = urlMatch[0];
                    }
                    
                    post.link = extractAndValidateLink(link);
                    
                    posts.push(post);
                }
            });
            
            if (posts.length >= 2) { // 至少解析出2条才认为成功
                parsedPosts = posts;
                return true;
            }
            
            return false;
        }
        
        function tryParseTableFormat(input) {
            const lines = input.split('\n').filter(line => line.trim() && (line.includes('|') || line.includes('\t')));
            
            if (lines.length < 2) return false;
            
            const posts = [];
            
            lines.forEach(line => {
                const parts = line.includes('|') ? 
                    line.split('|').map(p => p.trim()) : 
                    line.split('\t').map(p => p.trim());
                
                if (parts.length >= 3) {
                    // 尝试识别各个字段
                    const title = parts[0] || parts[1] || '无标题';
                    const author = parts.find(p => p.includes('[') && p.includes(']')) || 
                                   parts.find(p => p.includes('(') && p.includes(')')) || 
                                   parts[1] || '未知作者';
                    
                    // 提取数字（浏览量、点赞数、评论数）
                    const numbers = parts.filter(p => /^\d+$/.test(p)).map(Number);
                    
                    // 提取时间（包含"前"、"小时"、"分钟"等词）
                    const timePart = parts.find(p => /前$|小时|分钟|天/.test(p)) || '最近';
                    
                    // 提取链接
                    let link = '';
                    const linkPart = parts.find(p => p.startsWith('http'));
                    if (linkPart) link = linkPart;
                    
                    posts.push({
                        rank: posts.length + 1,
                        title: cleanText(title),
                        author: cleanText(author.replace(/[\[\]\(\)]/g, '')),
                        views: numbers[0] || 0,
                        likes: numbers[1] || 0,
                        comments: numbers[2] || 0,
                        time: timePart,
                        link: extractAndValidateLink(link)
                    });
                }
            });
            
            if (posts.length >= 2) {
                parsedPosts = posts;
                return true;
            }
            
            return false;
        }
        
        function tryParseNaturalLanguage(input) {
            // 用于解析自然语言描述的AI回复
            const lines = input.split('\n').filter(line => line.trim());
            const posts = [];
            let currentRank = 1;
            
            lines.forEach(line => {
                line = line.trim();
                
                // 跳过明显的非帖子行
                if (line.includes('以下是') || line.includes('热帖') || line.includes('排行榜') || 
                    line.includes('---') || line.includes('===') || line.length < 10) {
                    return;
                }
                
                // 提取标题（通常是最长的连续文本段）
                const titleMatch = line.match(/[^：:]+[:：]\s*(.+?)(?=\s+[\[\(]|$)/) || 
                                  line.match(/(.+?)(?=\s+[\[\(]|$)/);
                
                if (titleMatch) {
                    const title = titleMatch[1].trim();
                    
                    // 提取作者
                    const authorMatch = line.match(/[\[\(](.+?)[\]\)]/);
                    const author = authorMatch ? authorMatch[1].trim() : '未知作者';
                    
                    // 提取数字
                    const viewMatch = line.match(/(\d+)\s*浏览/);
                    const likeMatch = line.match(/(\d+)\s*点赞/);
                    const commentMatch = line.match(/(\d+)\s*评论/);
                    const timeMatch = line.match(/(\d+\s*(?:分钟|小时|天)前|今天|最近)/);
                    
                    // 提取链接
                    let link = '';
                    const linkMatch = line.match(/https?:\/\/\S+/);
                    if (linkMatch) link = linkMatch[0];
                    
                    posts.push({
                        rank: currentRank++,
                        title: title,
                        author: author,
                        views: viewMatch ? parseInt(viewMatch[1]) : 0,
                        likes: likeMatch ? parseInt(likeMatch[1]) : 0,
                        comments: commentMatch ? parseInt(commentMatch[1]) : 0,
                        time: timeMatch ? timeMatch[0] : '最近',
                        link: extractAndValidateLink(link)
                    });
                }
            });
            
            if (posts.length >= 2) {
                parsedPosts = posts;
                return true;
            }
            
            return false;
        }
        
        function tryParseGeneric(input) {
            // 通用解析：按行处理，智能提取
            const lines = input.split('\n').filter(line => line.trim());
            const posts = [];
            
            lines.forEach((line, index) => {
                line = line.trim();
                
                // 跳过明显的非帖子行
                if (line.includes('以下是') || line.includes('热帖') || line.includes('排行榜') || 
                    line.includes('---') || line.includes('===') || line.length < 5) {
                    return;
                }
                
                // 提取可能的标题（最长连续中文/英文文本）
                const titleMatch = line.match(/[^0-9\s\.、](.{5,50}?)(?=\s*[\[\(]|\s+\d|$)/);
                if (titleMatch) {
                    const title = titleMatch[0].trim();
                    
                    // 提取作者
                    let author = '未知作者';
                    const authorMatch = line.match(/[\[\(]([^\]\)]+)[\]\)]/);
                    if (authorMatch) author = authorMatch[1].trim();
                    
                    // 提取所有数字
                    const numbers = line.match(/\d+/g);
                    
                    // 提取时间
                    let time = '最近';
                    const timeMatch = line.match(/(\d+\s*(?:分钟|小时|天)前|今天|最近)/);
                    if (timeMatch) time = timeMatch[0];
                    
                    // 提取链接
                    let link = '';
                    const linkMatch = line.match(/https?:\/\/\S+/);
                    if (linkMatch) link = linkMatch[0];
                    
                    posts.push({
                        rank: index + 1,
                        title: cleanText(title),
                        author: cleanText(author),
                        views: numbers && numbers[0] ? parseInt(numbers[0]) : 0,
                        likes: numbers && numbers[1] ? parseInt(numbers[1]) : 0,
                        comments: numbers && numbers[2] ? parseInt(numbers[2]) : 0,
                        time: time,
                        link: extractAndValidateLink(link)
                    });
                }
            });
            
            if (posts.length >= 2) {
                parsedPosts = posts.slice(0, 20); // 最多20条
                return true;
            }
            
            return false;
        }
        
        function extractAndValidateLink(link) {
            if (!link) return '';
            
            // 清理链接
            link = link.trim();
            
            // 移除末尾的标点符号
            link = link.replace(/[.,;:!?]$/, '');
            
            // 验证链接格式
            const urlPattern = /^(https?:\/\/)?([\da-z.-]+)\.([a-z.]{2,6})([\/\w .-]*)*\/?$/;
            
            if (urlPattern.test(link)) {
                // 确保有http或https前缀
                if (!link.startsWith('http')) {
                    link = 'https://' + link;
                }
                return link;
            }
            
            return ''; // 无效链接返回空字符串
        }
        
        function cleanText(text) {
            return text
                .replace(/^[\.、\d\s]+/, '') // 去掉开头的序号
                .replace(/[\*\-_\s]+$/, '')  // 去掉结尾的符号
                .trim();
        }
        
        // ============================================
        // 【帖子详情功能】
        // ============================================
        
        function showPostDetail(post) {
            const overlay = document.getElementById('postDetailOverlay');
            const titleEl = document.getElementById('detailPostTitle');
            const metaEl = document.getElementById('detailPostMeta');
            const statsEl = document.getElementById('detailPostStats');
            const linkEl = document.getElementById('detailPostLink');
            
            // 设置帖子标题
            titleEl.textContent = post.title;
            
            // 设置元数据
            metaEl.innerHTML = `
                <div><i class="fas fa-user"></i> ${post.author}</div>
                <div><i class="far fa-clock"></i> ${post.time}</div>
                <div><i class="fas fa-fire"></i> 热度: ${calculateHotScore(post).toFixed(1)}</div>
            `;
            
            // 设置统计数据
            statsEl.innerHTML = `
                <div class="stat-item">
                    <div class="stat-value">${formatNumber(post.views)}</div>
                    <div class="stat-label">浏览</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${formatNumber(post.likes)}</div>
                    <div class="stat-label">点赞</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">${formatNumber(post.comments)}</div>
                    <div class="stat-label">评论</div>
                </div>
            `;
            
            // 设置链接
            if (post.link && post.link.trim() !== '') {
                linkEl.href = post.link;
                linkEl.classList.remove('link-unavailable');
            } else {
                linkEl.href = '#';
                linkEl.classList.add('link-unavailable');
                linkEl.style.display = 'none'; // 隐藏无效链接
            }
            
            // 显示详情页
            overlay.style.display = 'flex';
            document.body.style.overflow = 'hidden'; // 防止背景滚动
        }
        
        function closePostDetail() {
            const overlay = document.getElementById('postDetailOverlay');
            overlay.style.display = 'none';
            document.body.style.overflow = 'auto'; // 恢复滚动
        }
        
        // ============================================
        // 【预览和渲染】
        // ============================================
        
        function renderPreview() {
            const container = document.getElementById('previewArea');
            const count = document.getElementById('parsedCount');
            
            if (parsedPosts.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center; padding:50px 20px; color:#999;">
                        <i class="fas fa-exclamation-circle fa-2x"></i>
                        <p style="margin-top:15px;">没有解析到有效数据</p>
                    </div>
                `;
                count.textContent = '0条数据';
                return;
            }
            
            let html = '';
            
            parsedPosts.forEach((post, index) => {
                const hotScore = calculateHotScore(post);
                
                // 生成链接HTML（仅在链接有效时显示）
                let linkHtml = '';
                if (post.link && post.link.trim() !== '') {
                    linkHtml = `<a href="${post.link}" target="_blank" class="post-link" onclick="event.stopPropagation()">
                        <i class="fas fa-external-link-alt link-icon"></i> 链接
                    </a>`;
                }
                
                html += `
                    <div class="post-preview" onclick="showPostDetail(${JSON.stringify(post).replace(/"/g, '&quot;')})">
                        <div>
                            <span class="post-rank">${post.rank}</span>
                            <div class="post-title">${post.title} ${linkHtml}</div>
                        </div>
                        <div class="post-meta">
                            <span><i class="fas fa-user"></i> ${post.author}</span>
                            <span><i class="far fa-clock"></i> ${post.time}</span>
                            <span><i class="fas fa-fire"></i> 热度: ${hotScore.toFixed(1)}</span>
                        </div>
                        <div style="display:flex; gap:15px; font-size:12px; color:#666; margin-top:5px;">
                            <span><i class="far fa-eye"></i> ${formatNumber(post.views)} 浏览</span>
                            <span><i class="far fa-thumbs-up"></i> ${formatNumber(post.likes)} 点赞</span>
                            <span><i class="far fa-comment"></i> ${formatNumber(post.comments)} 评论</span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            count.textContent = `${parsedPosts.length}条数据`;
        }
        
        function renderPublicHotlist() {
            const publicData = JSON.parse(localStorage.getItem(STORAGE_KEYS.PUBLIC_DATA) || '{}');
            const posts = publicData.posts || [];
            const meta = publicData.meta || {};
            
            const container = document.getElementById('publicHotlist');
            
            if (posts.length === 0) {
                container.innerHTML = `
                    <div style="text-align:center; padding:80px 20px; color:#666;">
                        <i class="fas fa-inbox fa-3x"></i>
                        <h3 style="margin:20px 0 10px;">暂无热榜数据</h3>
                        <p>管理员正在准备今日热榜...</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            
            posts.forEach((post, index) => {
                const rankClass = index === 0 ? 'rank-1' : 
                                 index === 1 ? 'rank-2' : 
                                 index === 2 ? 'rank-3' : 'rank-other';
                
                const hotScore = calculateHotScore(post);
                
                // 生成链接HTML（仅在链接有效时显示）
                let linkHtml = '';
                if (post.link && post.link.trim() !== '') {
                    linkHtml = `<a href="${post.link}" target="_blank" class="item-link" onclick="event.stopPropagation()">
                        <i class="fas fa-external-link-alt link-icon"></i> 查看原帖
                    </a>`;
                }
                
                html += `
                    <div class="hotlist-item" onclick="showPostDetail(${JSON.stringify(post).replace(/"/g, '&quot;')})">
                        <div class="item-rank ${rankClass}">${index + 1}</div>
                        <div class="item-content">
                            <div class="item-title">
                                ${post.title}
                                ${linkHtml}
                            </div>
                            <div class="item-meta">
                                <span><i class="fas fa-user"></i> ${post.author}</span>
                                <span><i class="far fa-clock"></i> ${post.time}</span>
                                <span><i class="fas fa-fire"></i> 热度: ${hotScore.toFixed(1)}</span>
                            </div>
                            <div class="item-stats">
                                <div class="stat"><i class="far fa-eye"></i> ${formatNumber(post.views)} 浏览</div>
                                <div class="stat"><i class="far fa-thumbs-up"></i> ${formatNumber(post.likes)} 点赞</div>
                                <div class="stat"><i class="far fa-comment"></i> ${formatNumber(post.comments)} 评论</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // 更新标题和时间
            if (meta.title) {
                document.getElementById('publicTitle').textContent = meta.title;
            }
            if (meta.updateTime) {
                const timeStr = new Date(meta.updateTime).toLocaleString();
                document.getElementById('updateTime').textContent = `最后更新：${timeStr}`;
            }
        }
        
        // ============================================
        // 【数据保存和发布】
        // ============================================
        
        function saveToPublic() {
            if (parsedPosts.length === 0) {
                showSaveMessage('没有可发布的数据', 'error');
                return;
            }
            
            const title = document.getElementById('hotlistTitle').value || '今日频道热帖排行榜';
            const note = document.getElementById('updateNote').value || '数据来源于频道AI分析';
            const limit = parseInt(document.getElementById('displayCount').value) || 10;
            
            // 计算热度并排序
            parsedPosts.forEach(post => {
                post.hotScore = calculateHotScore(post);
            });
            
            parsedPosts.sort((a, b) => b.hotScore - a.hotScore);
            
            // 限制数量并重新排名
            const displayPosts = parsedPosts.slice(0, limit).map((post, index) => ({
                ...post,
                rank: index + 1
            }));
            
            // 准备保存的数据
            const publicData = {
                posts: displayPosts,
                meta: {
                    title: title,
                    note: note,
                    totalPosts: parsedPosts.length,
                    displayCount: displayPosts.length,
                    updateTime: new Date().toISOString(),
                    source: '频道AI分析'
                }
            };
            
            // 保存到本地存储
            localStorage.setItem(STORAGE_KEYS.PUBLIC_DATA, JSON.stringify(publicData));
            
            // 也保存原始数据（供管理员使用）
            localStorage.setItem(STORAGE_KEYS.HOTLIST_DATA, JSON.stringify({
                rawData: document.getElementById('aiInput').value,
                parsedData: parsedPosts,
                savedTime: new Date().toISOString()
            }));
            
            showSaveMessage(`成功发布 ${displayPosts.length} 条热帖数据到公共热榜`, 'success');
            
            // 更新公共热榜显示
            if (currentMode === 'public') {
                renderPublicHotlist();
            }
            
            // 禁用保存按钮，防止重复提交
            document.getElementById('saveBtn').disabled = true;
            
            // 记录操作
            addHistoryRecord('发布热榜数据', displayPosts.length);
        }
        
        // ============================================
        // 【界面控制函数】
        // ============================================
        
        function showAdminView() {
            currentMode = 'admin';
            document.getElementById('adminContainer').style.display = 'block';
            document.getElementById('publicContainer').style.display = 'none';
            document.getElementById('modeSwitchBtn').innerHTML = '<i class="fas fa-eye"></i> 查看热榜';
        }
        
        function showPublicView() {
            currentMode = 'public';
            document.getElementById('adminContainer').style.display = 'none';
            document.getElementById('publicContainer').style.display = 'block';
            document.getElementById('modeSwitchBtn').innerHTML = '<i class="fas fa-edit"></i> 编辑热榜';
            
            // 渲染公共热榜
            renderPublicHotlist();
        }
        
        function switchMode() {
            if (currentMode === 'admin') {
                showPublicView();
            } else {
                // 尝试显示管理员界面，如果需要登录会弹出登录框
                if (checkAutoLogin()) {
                    showAdminView();
                }
            }
        }
        
        function enableSaveButton() {
            document.getElementById('saveBtn').disabled = false;
        }
        
        function clearInput() {
            document.getElementById('aiInput').value = '';
            parsedPosts = [];
            renderPreview();
            document.getElementById('saveBtn').disabled = true;
            showParseStatus('输入已清空', 'success');
        }
        
        // ============================================
        // 【工具函数】
        // ============================================
        
        function calculateHotScore(post) {
            return (post.views * 0.5) + (post.likes * 0.3) + (post.comments * 0.2);
        }
        
        function formatNumber(num) {
            if (num >= 10000) return (num / 10000).toFixed(1) + '万';
            if (num >= 1000) return (num / 1000).toFixed(1) + '千';
            return num.toString();
        }
        
        function showParseStatus(message, type) {
            const statusEl = document.getElementById('parseStatus');
            statusEl.textContent = message;
            statusEl.className = `parse-status parse-${type}`;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 3000);
        }
        
        function showSaveMessage(message, type) {
            const msgEl = document.getElementById('saveMessage');
            msgEl.textContent = message;
            msgEl.className = `message message-${type}`;
            msgEl.style.display = 'block';
            
            setTimeout(() => {
                msgEl.style.display = 'none';
            }, 3000);
        }
        
        function showMessage(message, type) {
            // 临时消息提示
            const msgEl = document.createElement('div');
            msgEl.innerHTML = `
                <div style="position:fixed; top:20px; right:20px; padding:15px 20px; 
                     background:${type === 'success' ? '#d4edda' : '#f8d7da'}; 
                     color:${type === 'success' ? '#155724' : '#721c24'};
                     border:1px solid ${type === 'success' ? '#c3e6cb' : '#f5c6cb'};
                     border-radius:8px; z-index:9999; max-width:400px; box-shadow:0 4px 12px rgba(0,0,0,0.15);">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'times-circle'}"></i>
                    ${message}
                </div>
            `;
            
            document.body.appendChild(msgEl);
            setTimeout(() => msgEl.remove(), 3000);
        }
        
        function addHistoryRecord(action, count) {
            const history = JSON.parse(localStorage.getItem('ai_parser_history') || '[]');
            history.unshift({
                action: action,
                count: count,
                time: new Date().toISOString()
            });
            
            if (history.length > 50) history.pop();
            localStorage.setItem('ai_parser_history', JSON.stringify(history));
        }
        
        // ============================================
        // 【测试和示例数据】
        // ============================================
        
        function testWithSampleData() {
            const sampleData = `以下是今日频道热帖排行榜：

1. 今日技术分享：JavaScript新特性解析 [程序员小明] 2560浏览 320点赞 45评论 2小时前 链接：https://example.com/js-new-features
2. 前端框架对比：Vue vs React深度分析 [前端达人] 1890浏览 210点赞 32评论 3小时前 链接：https://example.com/vue-vs-react
3. 移动端适配最佳实践总结 [UI设计师] 1450浏览 180点赞 28评论 4小时前 链接：https://example.com/mobile-adaptation
4. 小程序开发经验分享 [开发小能手] 1320浏览 165点赞 25评论 5小时前 链接：https://example.com/mini-program
5. 数据库优化技巧 [后端架构师] 1250浏览 155点赞 22评论 6小时前 链接：https://example.com/database-optimization
6. 产品设计思维分享 [产品经理] 1180浏览 142点赞 20评论 7小时前 链接：https://example.com/product-design
7. 职场经验交流 [资深职场人] 1120浏览 135点赞 19评论 8小时前 链接：https://example.com/career-experience
8. 学习资源推荐 [学习委员] 1080浏览 128点赞 18评论 9小时前
9. 行业趋势分析 [行业观察员] 1050浏览 122点赞 17评论 10小时前 链接：无效链接
10. 日常技术问答 [热心网友] 980浏览 115点赞 16评论 11小时前 链接：https://example.com/tech-qa`;

            document.getElementById('aiInput').value = sampleData;
            parseAIResponse();
            showParseStatus('已加载示例数据，请点击"智能解析"', 'success');
        }
        
        // ============================================
        // 【页面初始化】
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            // 检查是否已登录
            if (checkAutoLogin()) {
                showAdminView();
            } else {
                showPublicView();
            }
            
            // 加载上一次的数据（如果有）
            const savedData = localStorage.getItem(STORAGE_KEYS.HOTLIST_DATA);
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    if (data.rawData) {
                        document.getElementById('aiInput').value = data.rawData;
                        showParseStatus('已加载上次保存的数据', 'success');
                    }
                } catch (e) {
                    // 忽略错误
                }
            }
            
            // 绑定回车键快捷解析
            document.getElementById('aiInput').addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'Enter') {
                    parseAIResponse();
                }
            });
            
            // 点击详情页外部关闭
            document.getElementById('postDetailOverlay').addEventListener('click', function(e) {
                if (e.target === this) {
                    closePostDetail();
                }
            });
            
            // ESC键关闭详情页
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closePostDetail();
                }
            });
        });
        
        // ============================================
        // 【获取H5链接】
        // ============================================
        function getH5Link() {
            // 生成当前页面的H5链接
            const h5Link = window.location.href;
            alert(`当前H5链接：\n${h5Link}\n\n将此链接分享给其他人，即可直接查看热榜。`);
            return h5Link;
        }
    </script>
</body>
</html>